name: Docker / unstable
on:
  push:
    branches:
      - develop
      - feature/gh-actions
env:
  APP_TAG: unstable
concurrency: gbs_myperformance
jobs:
  docker:
    name: docker
    runs-on: [self-hosted, windows]
    env:
      DOCKER_REGISTRY: "ghcr.io"
      DOCKER_REGISTRY_USERNAME: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
      DOCKER_REGISTRY_TOKEN: ${{ secrets.DOCKER_REGISTRY_TOKEN }}
    steps:
      - name: git checkout
        uses: actions/checkout@v3
      - name: docker login
        run : |
          docker login $env:DOCKER_REGISTRY -u $env:DOCKER_REGISTRY_USERNAME -p $env:DOCKER_REGISTRY_TOKEN
      # ----- BUILD
      - name: docker build - mssql
        run: |
          docker-compose -f ./GBS_MyPerformance.Containers.Prod/docker-compose.build.yml build mssql
      - name: docker build - caddy
        run: |
          docker-compose -f ./GBS_MyPerformance.Containers.Prod/docker-compose.build.yml build caddy
      - name: docker build - migrations
        run: |
          docker-compose -f ./GBS_MyPerformance.Containers.Prod/docker-compose.build.yml build migrations
      - name: docker build - app
        run: |
          docker-compose -f ./GBS_MyPerformance.Containers.Prod/docker-compose.build.yml build app
      # ----- PUBLISH
      - name: docker publish - mssql
        run: |
          docker-compose -f ./GBS_MyPerformance.Containers.Prod/docker-compose.build.yml push mssql
      - name: docker publish - caddy
        run: |
          docker-compose -f ./GBS_MyPerformance.Containers.Prod/docker-compose.build.yml push caddy
      - name: docker publish - migrations
        run: |
          docker-compose -f ./GBS_MyPerformance.Containers.Prod/docker-compose.build.yml push migrations
      - name: docker publish - app
        run: |
          docker-compose -f ./GBS_MyPerformance.Containers.Prod/docker-compose.build.yml push app
  cleanup:
    name: cleanup
    runs-on: [self-hosted, windows]
    needs: [docker]
    steps:
      - name: remove built docker images
        run: |
          docker image prune --force

# name: Docker Build unstable
# on:
#   push:
#     branches:
#       - develop
# env:
#   APP_TAG: unstable
# concurrency: gbs_myperformance
# ---

# name: Docker Build Version
